on:
  push:
    branches:
      - main
  workflow_dispatch:
    
jobs:
  build-api:
    name: "Bygger applikasjonen"
    uses: HelseVestIKT/HVI-Felles-WorkFlows/.github/workflows/build-dotnet-app.yaml@153-flere-appsettings-filer
    with:
      project-directory: './API'
      artifact-name: 'api'
      dotnet-version: '9.x'
    secrets: inherit

  build-angular-app:
    name: "Bygger Angular applikasjonen"
    uses: HelseVestIKT/HVI-Felles-WorkFlows/.github/workflows/build-angular-app.yaml@153-flere-appsettings-filer
    with:
      environment: 'Environment skal ikke sendes inn'
      project-directory: 'web'
      artifact-name: 'web'

  deploy-dev:
    name: "Deploy til DEV"
    needs: [build-api, build-angular-app]
    uses: ./.github/workflows/deploy-to-env.yaml 
    with:
      environment: "DEV"
    secrets: inherit
    permissions:
      contents: read
      id-token: write

  approve-qa:
    name: "Godkjenn QA deployment"
    runs-on: ubuntu-latest
    needs: [deploy-dev]
    environment: QA  # Kun denne jobben har environment protection
    steps:
      - name: Godkjenn QA deployment
        run: echo "QA deployment godkjent"

  deploy-qa:
    name: "Deploy til QA med godkjenning"
    needs: [build-api, build-angular-app, approve-qa]
    uses: ./.github/workflows/deploy-to-env.yaml 
    with:
      environment: "QA"
    secrets: inherit
    permissions:
      contents: read
      id-token: write 

