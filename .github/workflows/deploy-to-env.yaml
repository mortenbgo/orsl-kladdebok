name: "Provision og deploy til milj√∏"
on:
  workflow_call:
    inputs:
      environment:
        description: "Environment man vil deploye til"
        required: true
        type: string

jobs:
  validate-deployment-order:
    name: "Validate deployment order for ${{ inputs.environment }}"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Check deployment prerequisites
        run: |
          echo "üîç Checking deployment order for ${{ inputs.environment }}"
          
          # Get the current commit SHA
          COMMIT_SHA="${{ github.sha }}"
          
          # Check deployment order based on environment
          case "${{ inputs.environment }}" in
            "dev")
              echo "‚úÖ DEV deployment - no prerequisites required"
              ;;
            "qa")
              echo "üîç Checking if this commit is deployed to DEV..."
              # Check if there's a successful deployment to DEV for this commit
              dev_deployment=$(gh run list --workflow="deploy-to-env.yaml" --json conclusion,headSha,displayTitle --jq ".[] | select(.headSha==\"$COMMIT_SHA\" and .displayTitle | contains(\"DEV\") and .conclusion==\"success\")")
              
              if [[ -z "$dev_deployment" ]]; then
                echo "‚ùå Cannot deploy to QA: This commit has not been successfully deployed to DEV"
                echo "Please deploy to DEV first: $COMMIT_SHA"
                exit 1
              fi
              echo "‚úÖ DEV deployment verified for commit $COMMIT_SHA"
              ;;
            "prod")
              echo "üîç Checking if this commit is deployed to QA..."
              # Check if there's a successful deployment to QA for this commit
              qa_deployment=$(gh run list --workflow="deploy-to-env.yaml" --json conclusion,headSha,displayTitle --jq ".[] | select(.headSha==\"$COMMIT_SHA\" and .displayTitle | contains(\"QA\") and .conclusion==\"success\")")
              
              if [[ -z "$qa_deployment" ]]; then
                echo "‚ùå Cannot deploy to PROD: This commit has not been successfully deployed to QA"
                echo "Please deploy to QA first: $COMMIT_SHA"
                exit 1
              fi
              echo "‚úÖ QA deployment verified for commit $COMMIT_SHA"
              ;;
            *)
              echo "‚ùå Unknown environment: ${{ inputs.environment }}"
              exit 1
              ;;
          esac
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  manual-approval:
    name: "Manual Approval for ${{ inputs.environment }}"
    needs: [validate-deployment-order]
    runs-on: ubuntu-latest
    steps:
      - name: Create approval issue
        id: create-issue
        run: |
          # Create an issue for manual approval
          ISSUE_TITLE="üöÄ Deploy Approval: ${{ inputs.environment }} - $(date +%Y-%m-%d_%H-%M)"
          ISSUE_BODY="## Deployment Approval Request
          
          **Environment:** ${{ inputs.environment }}
          **Commit:** ${{ github.sha }}
          **Actor:** ${{ github.actor }}
          **Workflow:** ${{ github.workflow }}
          **Run ID:** ${{ github.run_id }}
          
          ### Deployment Details
          - **Repository:** ${{ github.repository }}
          - **Branch:** ${{ github.ref_name }}
          - **Triggered by:** ${{ github.event_name }}
          
          ### Actions
          To **APPROVE** this deployment, comment: \`‚úÖ APPROVE\`
          To **REJECT** this deployment, comment: \`‚ùå REJECT\`
          
          ---
          *This issue was automatically created by GitHub Actions*"
          
          issue_number=$(gh issue create \
            --title "$ISSUE_TITLE" \
            --body "$ISSUE_BODY" \
            --label "deployment-approval,${{ inputs.environment }}-deployment" \
            --assignee "${{ github.actor }}" \
            --json number --jq '.number')
          
          echo "issue_number=$issue_number" >> $GITHUB_OUTPUT
          echo "üìù Created approval issue #$issue_number"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Wait for approval
        run: |
          issue_number="${{ steps.create-issue.outputs.issue_number }}"
          echo "‚è≥ Waiting for approval on issue #$issue_number"
          echo "üîó View issue: ${{ github.server_url }}/${{ github.repository }}/issues/$issue_number"
          
          # Wait for approval comment
          timeout=1800  # 30 minutes timeout
          start_time=$(date +%s)
          
          while true; do
            current_time=$(date +%s)
            elapsed=$((current_time - start_time))
            
            if [[ $elapsed -gt $timeout ]]; then
              echo "‚ùå Timeout: No approval received within 30 minutes"
              gh issue comment $issue_number --body "‚ùå **TIMEOUT**: This deployment request has timed out after 30 minutes."
              gh issue close $issue_number
              exit 1
            fi
            
            # Check for approval/rejection comments
            comments=$(gh issue view $issue_number --json comments --jq '.comments[].body')
            
            if echo "$comments" | grep -q "‚úÖ APPROVE"; then
              echo "‚úÖ Deployment APPROVED!"
              gh issue comment $issue_number --body "‚úÖ **APPROVED**: Deployment will proceed."
              gh issue close $issue_number
              break
            elif echo "$comments" | grep -q "‚ùå REJECT"; then
              echo "‚ùå Deployment REJECTED!"
              gh issue comment $issue_number --body "‚ùå **REJECTED**: Deployment has been cancelled."
              gh issue close $issue_number
              exit 1
            fi
            
            echo "‚è≥ Still waiting for approval... (${elapsed}s elapsed)"
            sleep 30
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  approve-environment:
    name: "Godkjenn deploy til ${{ inputs.environment }}"
    needs: [manual-approval]
    runs-on: ubuntu-latest
    steps:
      - name: Godkjenn deploy, hent ut alle variabler og secrets for mij√∏et og legg dem i to variabler som gjenbrukes av andre steg
        id: approve
        run: |
          echo "‚úÖ Deployment approved, proceeding with ${{ inputs.environment }}"
          echo "Henter ut alle variabler og secrets for ${{ inputs.environment }}"
          echo '${{ toJSON(vars) }}'
          echo '${{ toJSON(secrets) }}'
          vars_json='${{ toJSON(vars) }}'
          secrets_json='${{ toJSON(secrets) }}'

          # Lagre som compressed JSON (√©n linje)
          vars_json=$(echo '${{ toJSON(vars) }}' | jq -c .)
          secrets_json=$(echo '${{ toJSON(secrets) }}' | jq -c .)

          # print content for debugging
          echo "Vars JSON:$vars_json"
          echo "Secrets JSON:$secrets_json"
    
          echo "vars_json=$vars_json" >> $GITHUB_OUTPUT
          echo "secrets_json=$secrets_json" >> $GITHUB_OUTPUT
    outputs:
        vars_json: ${{ steps.approve.outputs.vars_json }}
        secrets_json: ${{ steps.approve.outputs.secrets_json }}


  debug-before-deploy:
    name: "Debug f√∏r deploy"
    needs: [approve-environment]
    runs-on: ubuntu-latest
    steps:
      - name: Debug outputs fra approve-environment
        run: |
          echo "=== DEBUGGING OUTPUTS ==="
          echo "vars_json fra approve-environment:"
          echo '${{ needs.approve-environment.outputs.vars_json }}'
          echo ""
          echo "secrets_json fra approve-environment:"
          echo '${{ needs.approve-environment.outputs.secrets_json }}'
          echo ""
          echo "=== END DEBUG ==="        

  # build-angular-app:
  #   name: "Bygger Angular applikasjonen"
  #   uses: HelseVestIKT/HVI-Felles-WorkFlows/.github/workflows/build-angular-app.yaml@31-milj√∏-i-angular 
  #   needs: approve-environment
  #   with:
  #     environment: ${{ inputs.environment }}
  #     working-directory: 'web'
  #     artifact-name: 'web'
  #     angular-version: '20'
      

  # provision-angular-app-service:
  #   name: "Provision Angular App Service for ${{ inputs.environment }}"
  #   uses: HelseVestIKT/HVI-Felles-WorkFlows/.github/workflows/provision-app-service.yaml@31-milj√∏-i-angular
  #   needs: build-angular-app
  #   secrets: inherit
  #   with:
  #     environment: ${{ inputs.environment }}
  #     artifact-name: 'web'
  #     ekstern-tilgang: false
  #     debug: false            
  #   permissions:
  #     contents: read
  #     id-token: write

  # provision-app-service:
  #   name: "Deploy til ${{ inputs.environment }}"
  #   uses: HelseVestIKT/HVI-Felles-WorkFlows/.github/workflows/provision-app-service.yaml@31-milj√∏-i-angular
  #   needs: provision-angular-app-service
  #   secrets: inherit
  #   with:
  #     environment: ${{ inputs.environment }}
  #     artifact-name: 'api'
  #     ekstern-tilgang: false
  #     debug: false            
  #   permissions:
  #     contents: read
  #     id-token: write

  # deploy-db:
  #   name: "Deploy database til ${{ inputs.environment }}"
  #   uses: HelseVestIKT/HVI-Felles-WorkFlows/.github/workflows/deploy-database.yaml@31-milj√∏-i-angular
  #   needs: provision-app-service
  #   with:
  #     environment: ${{ inputs.environment }}
  #     db-name: ${{vars.APP_NAME}}-api      
  #   secrets: inherit
  #   permissions:
  #     contents: read
  #     id-token: write

  # print-connection-string-from-deploy-db:
  #   name: "Print connection string for ${{ inputs.environment }}"
  #   runs-on: ubuntu-latest
  #   needs: deploy-db
  #   steps:
  #     - name: Print connection string
  #       run: |
  #         echo "Connection string for ${{ inputs.environment }}: ${{ needs.deploy-db.outputs.sqlconnectionstring }}"

  # add-managed-id:
  #   name: "Legg til managed identity for ${{ inputs.environment }}"
  #   needs: [deploy-db, provision-app-service, print-connection-string-from-deploy-db]
  #   uses: HelseVestIKT/HVI-Felles-WorkFlows/.github/workflows/add-managedid-to-database.yaml@31-milj√∏-i-angular
  #   with:
  #     environment: ${{ inputs.environment }}
  #     app-name: ${{ vars.APP_NAME }}-api
  #     sql-connection-string: ${{ needs.deploy-db.outputs.sqlconnectionstring }}
  #   secrets: inherit
  #   permissions:
  #     contents: read
  #     id-token: write

  deploy-api:
    name: "Deploy API til ${{ inputs.environment }}"
    # needs: [add-managed-id, deploy-db, approve-environment]
    needs: [approve-environment, debug-before-deploy]
    uses: HelseVestIKT/HVI-Felles-WorkFlows/.github/workflows/deploy-dotnet-app.yaml@31-milj√∏-i-angular-niktsa    
    with:
      environment: ${{ inputs.environment }}
      commit-hash: ${{ github.sha }}
      artifact-name: 'api'
      connection-string-name: 'KladdebokDbConnection'
      # connection-string: ${{ needs.deploy-db.outputs.sqlconnectionstring }}
      # secrets-json:   ${{ needs.approve-environment.outputs.secrets_json }}
      vars-json:      ${{ needs.approve-environment.outputs.vars_json }}
    secrets:
      secrets_json: ${{ needs.approve-environment.outputs.secrets_json }}      
    permissions:
      contents: read
      id-token: write

  # deploy-web:
  #   name: "Deploy Web til ${{ inputs.environment }}"
  #   needs: [provision-angular-app-service, build-angular-app]
  #   uses: HelseVestIKT/HVI-Felles-WorkFlows/.github/workflows/deploy-angular-app.yaml@31-milj√∏-i-angular
  #   with:
  #     environment: ${{ inputs.environment }}
  #     commit-hash: ${{ github.sha }}
  #     artifact-name: 'web'

  #   secrets: inherit
  #   permissions:
  #     contents: read
  #     id-token: write
